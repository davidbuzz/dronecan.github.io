<h1 id="parsing-dsdl-definitions">Parsing DSDL definitions</h1>

<p>Create a file named <code class="highlighter-rouge">namespace_a/Foo.uavcan</code> with the following content:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">uavcan</span><span class="o">.</span><span class="n">Timestamp</span> <span class="n">timestamp</span>
<span class="n">uint8</span> <span class="n">MY_FAVORITE_CHAR</span> <span class="o">=</span> <span class="s">'</span><span class="se">\x42</span><span class="s">'</span>
</code></pre>
</div>

<p>Create another file named <code class="highlighter-rouge">namespace_b/Bar.uavcan</code> with the following content:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">float16</span> <span class="n">x</span>
<span class="n">float16</span><span class="p">[</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">]</span> <span class="n">y</span>
<span class="o">---</span>
<span class="n">uint6</span> <span class="n">JUST_ENOUGH</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">float64</span> <span class="n">answer</span>
<span class="n">namespace_a</span><span class="o">.</span><span class="n">Foo</span> <span class="n">foo</span>
</code></pre>
</div>

<p>Place the standard DSDL definitions into the directory <code class="highlighter-rouge">dsdl/</code>
(just clone or symlink the DSDL repository into the current directory).</p>

<p>The resulting directory structure should look like this:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">namespace_a</span><span class="o">/</span>
    <span class="n">Foo</span><span class="o">.</span><span class="n">uavcan</span>
<span class="n">namespace_b</span><span class="o">/</span>
    <span class="n">Bar</span><span class="o">.</span><span class="n">uavcan</span>
<span class="n">dsdl</span><span class="o">/</span>
    <span class="n">uavcan</span><span class="o">/</span>
        <span class="o">...</span>
<span class="o">...</span>
</code></pre>
</div>

<p>Put this code into a file in the current directory:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#</span>
<span class="c"># Pyuavcan DSDL parser demo.</span>
<span class="c"># Read the package docstrings for details.</span>
<span class="c">#</span>

<span class="c"># pyuavcan supports Python 2.7 and Python 3.x</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">uavcan</span> <span class="kn">import</span> <span class="n">dsdl</span>

<span class="c"># Root namespace directories:</span>
<span class="n">NAMESPACE_DIRS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'namespace_a/'</span><span class="p">,</span> <span class="s">'namespace_b/'</span><span class="p">]</span>

<span class="c"># Where to look for the referenced types (standard UAVCAN types):</span>
<span class="n">SEARCH_DIRS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'dsdl/uavcan'</span><span class="p">]</span>

<span class="c"># Run the DSDL parser:</span>
<span class="n">types</span> <span class="o">=</span> <span class="n">dsdl</span><span class="o">.</span><span class="n">parse_namespaces</span><span class="p">(</span><span class="n">NAMESPACE_DIRS</span><span class="p">,</span> <span class="n">SEARCH_DIRS</span><span class="p">)</span>

<span class="c"># Print what we got</span>
<span class="n">ATTRIBUTE_INDENT</span> <span class="o">=</span> <span class="s">' '</span> <span class="o">*</span> <span class="mi">3</span>

<span class="k">def</span> <span class="nf">print_attributes</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">constants</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ATTRIBUTE_INDENT</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">'  # '</span><span class="p">)</span>
        <span class="c"># Add a bit of relevant information for this type:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">CATEGORY_COMPOUND</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'DSDL signature: 0x</span><span class="si">%08</span><span class="s">X'</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">get_dsdl_signature</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">CATEGORY_ARRAY</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Max array size: </span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">max_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">CATEGORY_PRIMITIVE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Bit length: </span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">bitlen</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">constants</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ATTRIBUTE_INDENT</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="nb">type</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">'='</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s">'#'</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">init_expression</span><span class="p">)</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">KIND_MESSAGE</span><span class="p">:</span>
        <span class="n">print_attributes</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">constants</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">KIND_SERVICE</span><span class="p">:</span>
        <span class="n">print_attributes</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">request_fields</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">request_constants</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ATTRIBUTE_INDENT</span><span class="p">,</span> <span class="s">'---'</span><span class="p">)</span>
        <span class="n">print_attributes</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">response_fields</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">response_constants</span><span class="p">)</span>
</code></pre>
</div>

<p>Make sure the Pyuavcan package is installed, then run the script.
The output should look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>namespace_a.Foo
    uavcan.Timestamp timestamp  # DSDL signature: 0xF776DD8697A8DB73
    saturated uint8 MY_FAVORITE_CHAR = 66 # '\x42'
namespace_b.Bar
    saturated float16 x  # Bit length: 16
    saturated float16[&lt;=7] y  # Max array size: 7
    ---
    saturated float64 answer  # Bit length: 64
    namespace_a.Foo foo  # DSDL signature: 0xFE327FCBE8C6F7D
    saturated uint6 JUST_ENOUGH = 42 # 42
</code></pre>
</div>

<p>For a real world usage example it’s recommended to refer to Libuavcan,
which implements a DSDL compiler based on the DSDL parsing module from Pyuavcan.</p>
